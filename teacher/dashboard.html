import { callApi } from "../api.js";

document.addEventListener("DOMContentLoaded", () => {

  /* ================= DOM ================= */
  const teacherNameEl   = document.getElementById("teacherName");
  const teacherEmailEl  = document.getElementById("teacherEmail");

  const totalSessionsEl = document.getElementById("totalSessions");
  const openSessionsEl  = document.getElementById("openSessions");
  const totalAttendEl   = document.getElementById("totalAttendance");

  const tableBody       = document.getElementById("sessionTable");
  const msgEl           = document.getElementById("msg");

  // ✅ Export buttons (HTML ของคุณใช้ id นี้)
  const exportBtnTop    = document.getElementById("exportAllBtn");
  const exportBtnBar    = document.getElementById("exportAllBtn2");

  // ✅ Subject filter/chips (มีใน HTML)
  const subjectFilter   = document.getElementById("subjectFilter");
  const chipsEl         = document.getElementById("subjectSummaryChips");

  /* ===== Session detail modal ===== */
  const sessionModal      = document.getElementById("sessionModal");
  const modalCloseBtn     = document.getElementById("modalCloseBtn");
  const modalSubtitle     = document.getElementById("modalSubtitle");
  const modalStats        = document.getElementById("modalStats");
  const modalTableBody    = document.getElementById("modalTableBody");
  const modalFooterInfo   = document.getElementById("modalFooterInfo");
  const exportSessionBtn  = document.getElementById("exportSessionBtn");

  /* ===== Close-session modal ===== */
  const closeModal      = document.getElementById("closeModal");
  const modalText       = document.getElementById("modalText");
  const btnCancelX      = document.getElementById("btnCancel");   // ปุ่ม X ในหัว modal
  const btnCancel2      = document.getElementById("btnCancel2");  // ปุ่มยกเลิกด้านล่าง
  const btnConfirm      = document.getElementById("btnConfirm");

  /* ================= STATE ================= */
  let allSessions = [];
  let selectedSession = null;     // {sessionId, token, subject, room, ...}
  let closeTargetToken = null;

  /* ================= INIT ================= */
  const teacher = getTeacherSession();
  if (!teacher) {
    location.href = "login.html";
    return;
  }

  teacherNameEl.textContent  = teacher.name || "-";
  teacherEmailEl.textContent = teacher.email || "-";

  exportBtnTop?.addEventListener("click", exportAllCSV);
  exportBtnBar?.addEventListener("click", exportAllCSV);

  modalCloseBtn?.addEventListener("click", closeSessionModal);
  sessionModal?.addEventListener("click", (e) => { if (e.target === sessionModal) closeSessionModal(); });

  btnCancelX?.addEventListener("click", closeCloseModal);
  btnCancel2?.addEventListener("click", closeCloseModal);
  closeModal?.addEventListener("click", (e) => { if (e.target === closeModal) closeCloseModal(); });

  btnConfirm?.addEventListener("click", confirmCloseSession);

  exportSessionBtn?.addEventListener("click", exportCurrentSessionCSV);

  subjectFilter?.addEventListener("change", () => renderTableFiltered());

  // ✅ event delegation: จิ้มปุ่มในตาราง
  tableBody?.addEventListener("click", (e) => {
    const btn = e.target?.closest("button");
    if (!btn) return;

    const token = btn.dataset.token || "";
    const sid   = btn.dataset.sessionId || "";

    if (btn.dataset.action === "detail") {
      openSessionDetailById(sid);
      return;
    }

    if (btn.dataset.action === "close") {
      if (!token) return alert("ปุ่มนี้ไม่มี token");
      openCloseModal(token);
      return;
    }
  });

  loadDashboard();

  /* ================= LOAD DASHBOARD ================= */
  async function loadDashboard(){
    try{
      msgEl.textContent = "กำลังโหลด...";
      const res = await callApi("teacherGetDashboard", {});
      if(!res?.success) throw new Error(res?.message || "โหลดข้อมูลไม่สำเร็จ");

      const stats = res.stats || {};
      allSessions = Array.isArray(res.sessions) ? res.sessions : [];

      renderStats(stats);
      buildSubjectFilter(allSessions);
      renderTableFiltered();
      msgEl.textContent = "";

    }catch(err){
      console.error(err);
      msgEl.textContent = err?.message || "โหลดข้อมูลไม่สำเร็จ";
    }
  }

  function renderStats(stats){
    totalSessionsEl.textContent = stats.totalSessions ?? 0;
    openSessionsEl.textContent  = stats.openSessions ?? 0;
    totalAttendEl.textContent   = stats.totalAttendance ?? 0;
  }

  function buildSubjectFilter(list){
    if (!subjectFilter) return;

    const subjects = Array.from(new Set(
      list.map(s => String(s.subject || "-").trim()).filter(x => x && x !== "-")
    )).sort((a,b)=>a.localeCompare(b,"th"));

    // reset
    subjectFilter.innerHTML = `<option value="">ทั้งหมด</option>`;
    subjects.forEach(sub => {
      const opt = document.createElement("option");
      opt.value = sub;
      opt.textContent = sub;
      subjectFilter.appendChild(opt);
    });
  }

  function renderTableFiltered(){
    const filterVal = String(subjectFilter?.value || "").trim();
    const list = filterVal ? allSessions.filter(s => String(s.subject || "").trim() === filterVal) : allSessions;
    renderChips(list, filterVal);
    renderTable(list);
  }

  function renderChips(list, filterVal){
    if (!chipsEl) return;

    const total = list.length;
    const openCount = list.filter(s => String(s.status || "").toUpperCase() === "OPEN").length;

    chipsEl.innerHTML = `
      <div class="chip">แสดง: <span class="highlight">${escapeHtml(filterVal || "ทั้งหมด")}</span></div>
      <div class="chip">จำนวนคาบ: <span class="highlight">${total}</span></div>
      <div class="chip">คาบที่เปิดอยู่: <span class="highlight">${openCount}</span></div>
    `;
  }

  function renderTable(list){
    if(!tableBody) return;

    if(!list.length){
      tableBody.innerHTML = `<tr><td colspan="5" class="empty">ยังไม่มีข้อมูลคาบ</td></tr>`;
      return;
    }

    tableBody.innerHTML = "";

    list.forEach(s => {
      const tr = document.createElement("tr");

      const start  = s.startTime ?? s.startedAt ?? s.START_TIME ?? "-";
      const token  = String(s.token || "-").trim();
      const status = String(s.status || "-").toUpperCase();
      const sid    = String(s.sessionId || s.id || s.SESSION_ID || "").trim();

      tr.innerHTML = `
        <td>
          <div class="session-subject">${escapeHtml(s.subject || "-")}</div>
          <div class="session-room">${escapeHtml(s.room || "-")}</div>
        </td>
        <td>${escapeHtml(token || "-")}</td>
        <td>${escapeHtml(start)}</td>
        <td>
          <span class="status-pill ${status === "OPEN" ? "open" : "closed"}">
            ${escapeHtml(status)}
          </span>
        </td>
        <td style="display:flex; gap:8px; flex-wrap:wrap;">
          <button class="btn-mini" data-action="detail" data-session-id="${escapeHtml(sid)}">ดู</button>
          ${
            status === "OPEN"
              ? `<button class="btn-mini danger" data-action="close" data-token="${escapeHtml(token)}">ปิดคาบ</button>`
              : ``
          }
        </td>
      `;

      tableBody.appendChild(tr);
    });
  }

  /* ================= EXPORT ALL ================= */
  async function exportAllCSV(){
    try{
      setExportLoading(true);
      msgEl.textContent = "กำลังสร้างไฟล์ CSV...";

      const res = await callApi("teacherExportAll", {});
      if(!res?.success) throw new Error(res?.message || "Export ไม่สำเร็จ");

      const csvText = res.csv || res.csvText || "";
      if(!csvText) throw new Error("ไม่มีข้อมูล CSV จาก server");

      downloadCSV(csvText, `attendance_all_${new Date().toISOString().slice(0,10)}.csv`);
      msgEl.textContent = "ดาวน์โหลดแล้ว ✅";

    }catch(err){
      console.error(err);
      alert(err?.message || "Export ไม่สำเร็จ");
      msgEl.textContent = err?.message || "Export ไม่สำเร็จ";
    }finally{
      setExportLoading(false);
    }
  }

  function setExportLoading(isLoading){
    if (exportBtnTop) exportBtnTop.disabled = !!isLoading;
    if (exportBtnBar) exportBtnBar.disabled = !!isLoading;
  }

  /* ================= SESSION DETAIL MODAL ================= */
  async function openSessionDetailById(sessionId){
    const sid = String(sessionId || "").trim();
    if(!sid) return alert("ไม่มี sessionId");

    try{
      selectedSession = null;
      openSessionModal();

      modalSubtitle.textContent = "กำลังโหลดรายละเอียด...";
      modalStats.innerHTML = "";
      modalFooterInfo.innerHTML = "";
      modalTableBody.innerHTML = `<tr><td colspan="4" class="empty">กำลังโหลด...</td></tr>`;
      exportSessionBtn.disabled = true;

      const res = await callApi("teacherGetSessionDetail", { sessionId: sid });
      if(!res?.success) throw new Error(res?.message || "โหลดรายละเอียดคาบไม่สำเร็จ");

      const sess = res.session || {};
      const stats = res.stats || {};
      const records = Array.isArray(res.records) ? res.records : [];

      selectedSession = {
        sessionId: String(sess.sessionId || sid),
        token: String(sess.token || ""),
        subject: String(sess.subject || "-"),
        room: String(sess.room || "-"),
        startTime: sess.startTime,
        status: String(sess.status || "-")
      };

      modalSubtitle.textContent = `${selectedSession.subject} • ห้อง ${selectedSession.room} • TOKEN: ${selectedSession.token}`;

      modalStats.innerHTML = `
        <span class="badge">ทั้งหมด: ${Number(stats.total ?? records.length)}</span>
        <span class="badge ok">มา: ${Number(stats.ok ?? 0)}</span>
        <span class="badge late">สาย: ${Number(stats.late ?? 0)}</span>
        <span class="badge absent">ขาด: ${Number(stats.absent ?? 0)}</span>
      `;

      modalFooterInfo.innerHTML = `
        <span class="badge">สถานะ: ${escapeHtml(selectedSession.status)}</span>
        <span class="badge">เริ่ม: ${escapeHtml(String(selectedSession.startTime ?? "-"))}</span>
      `;

      if(!records.length){
        modalTableBody.innerHTML = `<tr><td colspan="4" class="empty">ยังไม่มีการเช็คชื่อในคาบนี้</td></tr>`;
      }else{
        modalTableBody.innerHTML = records.map(r => `
          <tr>
            <td>${escapeHtml(r.studentId || "-")}</td>
            <td>${escapeHtml(r.studentName || "-")}</td>
            <td>${escapeHtml(r.time || "-")}</td>
            <td>${escapeHtml(String(r.status || "-").toUpperCase())}</td>
          </tr>
        `).join("");
      }

      exportSessionBtn.disabled = !selectedSession.token;

    }catch(err){
      console.error(err);
      modalSubtitle.textContent = "โหลดไม่สำเร็จ";
      modalTableBody.innerHTML = `<tr><td colspan="4" class="empty">${escapeHtml(err?.message || "โหลดรายละเอียดคาบไม่สำเร็จ")}</td></tr>`;
      exportSessionBtn.disabled = true;
    }
  }

  async function exportCurrentSessionCSV(){
    try{
      if(!selectedSession?.token){
        alert("ยังไม่มี token ของคาบนี้");
        return;
      }

      exportSessionBtn.disabled = true;

      // ✅ ฝั่ง GAS ของคุณรองรับ teacherExportSession (คืน csv)
      const res = await callApi("teacherExportSession", { token: selectedSession.token });
      if(!res?.success) throw new Error(res?.message || "Export คาบไม่สำเร็จ");

      const csvText = res.csv || res.csvText || "";
      if(!csvText) throw new Error("ไม่มีข้อมูล CSV จาก server");

      const safeTok = String(selectedSession.token || "SESSION").replace(/[^A-Z0-9_-]/gi, "_");
      downloadCSV(csvText, `attendance_${safeTok}_${new Date().toISOString().slice(0,10)}.csv`);

    }catch(err){
      console.error(err);
      alert(err?.message || "Export คาบไม่สำเร็จ");
    }finally{
      exportSessionBtn.disabled = false;
    }
  }

  function openSessionModal(){
    sessionModal?.classList.add("open");
    sessionModal?.setAttribute("aria-hidden", "false");
  }
  function closeSessionModal(){
    sessionModal?.classList.remove("open");
    sessionModal?.setAttribute("aria-hidden", "true");
  }

  /* ================= CLOSE SESSION ================= */
  function openCloseModal(token){
    closeTargetToken = String(token || "").trim().toUpperCase();
    if (modalText) modalText.textContent = `ยืนยันปิดคาบ TOKEN: ${closeTargetToken}`;
    closeModal?.classList.add("open");
    closeModal?.setAttribute("aria-hidden", "false");
  }

  function closeCloseModal(){
    closeModal?.classList.remove("open");
    closeModal?.setAttribute("aria-hidden", "true");
    closeTargetToken = null;
  }

  async function confirmCloseSession(){
    if(!closeTargetToken){
      alert("ไม่มี token คาบ");
      return;
    }

    btnConfirm.disabled = true;

    try{
      const res = await callApi("teacherCloseSession", { token: closeTargetToken });
      if(!res?.success) throw new Error(res?.message || "ปิดคาบไม่สำเร็จ");

      closeCloseModal();
      await loadDashboard();

    }catch(err){
      console.error(err);
      alert(err?.message || "ปิดคาบไม่สำเร็จ");
    }finally{
      btnConfirm.disabled = false;
    }
  }

  /* ================= UTILS ================= */
  function downloadCSV(csvText, filename){
    // ✅ ใส่ BOM กันภาษาไทยใน Excel
    const bom = "\uFEFF";
    const blob = new Blob([bom + csvText], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
  }

  function getTeacherSession(){
    try{
      const raw = localStorage.getItem("teacherSession");
      if(!raw) return null;
      const obj = JSON.parse(raw);

      const teacherId = String(obj.teacherId ?? obj.id ?? "").trim();
      const email = String(obj.email ?? "").trim();
      const name = String(obj.name ?? "").trim();

      if(!teacherId && !email && !name) return null;
      return { ...obj, teacherId, id: teacherId || obj.id || "", email, name };
    }catch{
      return null;
    }
  }

  function escapeHtml(v){
    return String(v ?? "").replace(/[&<>"']/g, (m) => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

});
